# xmppmini
这是一个针对 xmpp 协议进行裁剪,以使 xmpp 协议真正实用化的项目

经过多年的 xmpp 协议相关的开发,我们发觉 xmpp 协议真正的缺陷其实不是功能不足,而是太过臃肿. xmpp 协议想要象 smtp/pop3 这样成为真正的网络应用协议应该要精练化,我们项目中的 mini 就指的是"精练"这一过程.在实际的应用中,我们发现精简后的 xmpp 协议反而能在更多的领域找到自己的位置.

## 我们精简的方式主要是:
xmpp 协议尽量只负责即时通讯部分,而文件传输,甚至于视频应用这些其实都可以交给传统的 http 或者是其他协议,没必要(其实也不可能)大包大揽.这样精简后的 xmpp 协议也会让各个希望接入的客户端更容易接入.

## 我们的目标产品主要有两个:
客户端和服务器.其中客户端包括一整套各种方便大家使用的 sdk ,至少会包括各大主流开发语言,同时也会发布精练后的 xmpp 协议规范,我们直接称谓这个规范为 xmppmini 规范. 同时也会发布一个供大家方便使用的 xmppmini 规范的服务器,这个服务器同时也会兼容目前市面上的所有 xmpp 客户端.

## xmppmini 的寻址方式
越用到最后越会发现和电子邮件的 smtp/pop3 协议相似，要开发一个实用的 xmppmini 项目特别是服务器端单靠 xmpp 协议其实是无法完成的，这就是为什么所有的免费电子邮箱服务商都会有一个自己的 web 端一样。而 xmpp 协议最大的问题就在于想将一切大包大览，这肯定是不现实的，在现在即时通讯的暂时屏蔽某用户功能为例子，这在 xmpp 协议中没有，难道为了实现这一功能我要先提交给协议正式通过吗？显然行不通，所以在 xmppmini 项目中我们不可能定那么死，很多功能接口应当只给出一个 http 地址，让各服务商自行提供 web 地址，然后客户端去访问就行了（当然服务商自己的 web 端还可以提供更强大的功能，这里的意思是 xmppmini 只是稍微规范了一下入口的地址而已，服务商也不用非要实现这个规范）。这里要说明的寻址方式和后面的附加消息格式都是如此。

###### 1.一个地址的服务器查找方式  
例如 clq@newbt.net 一个客户端 socket 如何知道去连接什么 ip 和 端口呢？  
传统上比较简单：直接使用 dns 解析出 ip 然后默认规定大家使用 5222 端口就行了，如果是 ssl/tls 安全端口则为 5223。（另外还有一些扩展的寻址方法我们就不讨论了）  

现在很多协议比如电子邮件的 smtp 协议通过在 dns 附加信息来扩展一些功能，例如 dkim 的密钥等等，但这样会产生一些问题。现在的程序开发 api 中对 dns 的支持可以说是非常的弱，无论对客户端还是服务端都是如此，所以我们使用的不是 dns 扩展，而是网络协议中发展得最为成熟的 http 即 web 的方式，而且尽量降低接口的实现难度。举个简单的例子，cdn 加速对于 dns 来说就几乎是不可能实现的（当然实际上是可以的，这里指方便性，取得的难易而言），而 http 方面现在则是有各种各样几近无数的云系统可供选择。

所以我们扩展寻址方式的第一个就很容易理解：在域名默认站点下如果有 xmppmini.txt 的话优先查找它里面注明的地址，不存在这个文件的话再按传统查找 dns 。例如：  
地址 clq@clqsoft.com ，首先访问 http://clqsoft.com/xmppmini.txt  
其内容假设为：  
host=clqsoft.com  

其中的换行遵循网络协议格式，为 CRLF ，不可直接为自己操作系统的换行。  

则表示其实服务器为 clqsoft.com 上的 5222 端口（或 5223 安全端口）。  
那么假如象邮件服务器一样，我的地址是托管在别人的服务器上的怎么办呢？很简单，修改 host 节的地址为托管服务器即可，例如：  
host=newbt.net  

这就表示说，要将信息发送给 clq@clqsoft.com 的话，请连接 newbt.net 的 5222 端口（或 5223 安全端口）。这其实等同于 smtp 中 dns 的 mx 记录。      

传统上到这一步就差不多了，但我们 xmppmini 根据项目实际运行经验还加上了一个重要的功能：动态查询。以一个公司发展为例，公司尚小时只用一台服务器即可满足需要，以上接口就足够了。但当公司壮大后需要增加服务器时，我如果知道应当连接那一台机器呢？传统上的解决其实还是用 dns ，将一个域名解析为多台 ip 所在的机器就可以了，这对客户端来说是非常方便的，无需任何变动。但这对服务器来说要做的改动太多太多的，根据我们的经验，现有的 xmpp 服务器软件几乎没有现成可用的，要完成这一功能不自己修改代码几乎是不可能是。在以往的工作中，有一个方法可以很容易的解决这个问题：将地址再细化，每个用户自己有一个固定的服务器，然后再在客户端软件中给出一个假的统一域名的地址就行了。例如： clq_a@a.clqsoft.com，clq_b@b.clqsoft.com 这两个地址是真实的 xmpp 地址，任何一种 xmpp 服务器软件都支持的，然后在自己的客户中显示为 clq_a@clqsoft.com，clq_b@clqsoft.com 就可以了，但这样只适合做在自己公司的 app 中，面向大众不可能要求其他的客户端都这样改。要解决这个问题其实也很简单，在服务器交互时增加一个查询就可以了，客户端一样不需要做任何改动。所以我们的 xmppmini 寻址就有了以下方式：   
host=http://newbt.net/xmppmini.php?action=get_host  
server_dyn=1  

当我们要将消息发送给 clq_a@clqsoft.com 时，只要访问 http://newbt.net/xmppmini.php?action=get_host  传递一个值为 clq_a@clqsoft.com 的 user_name 参数就可以查询到它所在的服务器了。参数即可以通过 post 方式，也可以通过 get 方式传递。例如用浏览器直接访问 http://newbt.net/xmppmini.php?action=get_host&user_name=clq_a@clqsoft.com   

这一地址返回的内容格式也和 xmppmini.txt 一样，不过这其中的 host 应该是固定的，不能再支持动态再向下级查询了（当然特殊需要的用户可以自行实现再向下查询，但对于 xmppmini 项目来说简单是第一要务，就不支持了）。  

这一扩展一般在服务端实现，但对于不想修改服务器软件的用户来说，直接在客户端实现也是可以的，一样简单。  

其中的换行遵循网络协议格式，为 CRLF ，不可直接为自己操作系统的换行。  

对于示例中的 xmppmini.php 当然可以换成 aspx/jsp 来实现，相信这对于一个程序员来说是非常简单的事情，我们就不赘述了。  

## xmppmini 的附加消息格式


--------
加入我们! 让我们一起努力吧,让 xmpp 即时通讯也能象 email 一样成为互联网的标配!
